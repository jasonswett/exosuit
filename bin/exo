#!/usr/bin/env ruby

require 'open3'
require 'pry'
require 'json'

module Exosuit
  require 'yaml'

  def self.config
    config_dir = './.exosuit'
    filename = "#{config_dir}/config.yml"
    YAML::load_file(filename)
  end

  def self.dns_names
    command = 'aws ec2 describe-instances --filters Name=instance-state-name,Values=running --profile=personal'
    response, _, _ = Open3.capture3(command)

    JSON.parse(response)['Reservations'].map do |data|
      data['Instances'][0]['PublicDnsName']
    end
  end
end

aws_cli_installed = system('which aws', out: File::NULL)

unless aws_cli_installed
  puts 'Missing dependency: AWS CLI is not installed.'
  puts 'Visit https://aws.amazon.com/cli/ and install the AWS CLI, then try the exo command again.'
  exit
end

if ARGV[0] == 'launch'
  system('./scripts/keypair.sh')
  command = "./scripts/launch.sh #{Exosuit.config['keypair']['name']}"
  system(command)
  exit
end

if ARGV[0] == 'describe-instances'
  system('aws ec2 describe-instances')
  exit
end

if ARGV[0] == 'dns'
  puts Exosuit.dns_names
  exit
end

if ARGV[0] == 'ssh'
  dns_name = Exosuit.dns_names[0]
  command = "ssh -i #{Exosuit.config['keypair']['path']} -o StrictHostKeychecking=no ubuntu@#{dns_name}"
  puts command
  system(command)
  exit
end

puts 'Usage:'
puts '  exo [command]'
puts
puts 'These are the commands you can use:'
puts '  launch                 Launch a new EC2 instance'
puts '  describe-instances     Alias for aws ec2 describe-instances'
puts '  dns                    List public DNS names for all EC2 instances'
